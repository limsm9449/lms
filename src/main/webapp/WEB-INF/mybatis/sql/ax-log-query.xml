<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="axLog">

	<select id="axLogList" resultType="hashmap">
		SELECT 	A.*
				,DATE_FORMAT(A.CREATE_DATE, '%y.%m.%d %H:%i') CREATE_DATE_STR
				,U1.USER_NAME
		FROM 	REQUEST_LOG A
                    LEFT OUTER JOIN USER U1 ON A.USER_ID = U1.USER_ID
	 	WHERE 	DATE_FORMAT(A.CREATE_DATE, '%Y-%m-%d') BETWEEN #{FROM_DT} AND #{TO_DT}		
		<if test="SEARCH_STR != null and SEARCH_STR != ''">
			<if test="CB_SEARCHKIND == 'USER_ID'">
			  AND UPPER(A.USER_ID) LIKE CONCAT('%',UPPER(#{SEARCH_STR}),'%') 
			</if>
			<if test="CB_SEARCHKIND == 'USER_NAME'">
			  AND UPPER(U1.USER_NAME) LIKE CONCAT('%',UPPER(#{SEARCH_STR}),'%') 
			</if>
		</if>			 
		<if test="SEARCH_STR2 != null and SEARCH_STR2 != ''">
		  AND A.URL LIKE CONCAT('%',#{SEARCH_STR2},'%') 
		</if>			 
		ORDER BY A.CREATE_DATE DESC
	</select>

	<select id="axLoginLogList" resultType="hashmap">
		SELECT 	A.SEQ
				,A.USER_ID
				,DATE_FORMAT(A.LOGIN_TIME, '%y.%m.%d %H:%i') LOGIN_TIME_STR
				,DATE_FORMAT(IFNULL(A.LOGOUT_TIME, A.LAST_TIME), '%y.%m.%d %H:%i') LOGOUT_TIME_STR
				,A.LOGIN_IP
				,U1.USER_NAME
		FROM 	USER_LOGIN A
                    LEFT OUTER JOIN USER U1 ON A.USER_ID = U1.USER_ID
	 	WHERE 	DATE_FORMAT(A.LOGIN_TIME, '%Y-%m-%d') BETWEEN #{FROM_DT} AND #{TO_DT}		
		<if test="SEARCH_STR != null and SEARCH_STR != ''">
			<if test="CB_SEARCHKIND == 'USER_ID'">
			  AND UPPER(A.USER_ID) LIKE CONCAT('%',UPPER(#{SEARCH_STR}),'%') 
			</if>
			<if test="CB_SEARCHKIND == 'USER_NAME'">
			  AND UPPER(U1.USER_NAME) LIKE CONCAT('%',UPPER(#{SEARCH_STR}),'%') 
			</if>
		</if>			 
		ORDER BY A.LOGIN_TIME DESC
	</select> 
	
	<select id="axLoginMonthLogList" resultType="hashmap">
		SELECT 	A.*
				,U1.USER_NAME
		FROM 	(
					SELECT 	USER_ID
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '01' THEN 1 ELSE 0 END) DAY_01
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '02' THEN 1 ELSE 0 END) DAY_02
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '03' THEN 1 ELSE 0 END) DAY_03
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '04' THEN 1 ELSE 0 END) DAY_04
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '05' THEN 1 ELSE 0 END) DAY_05
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '06' THEN 1 ELSE 0 END) DAY_06
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '07' THEN 1 ELSE 0 END) DAY_07
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '08' THEN 1 ELSE 0 END) DAY_08
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '09' THEN 1 ELSE 0 END) DAY_09
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '10' THEN 1 ELSE 0 END) DAY_10
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '11' THEN 1 ELSE 0 END) DAY_11
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '12' THEN 1 ELSE 0 END) DAY_12
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '13' THEN 1 ELSE 0 END) DAY_13
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '14' THEN 1 ELSE 0 END) DAY_14
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '15' THEN 1 ELSE 0 END) DAY_15
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '16' THEN 1 ELSE 0 END) DAY_16
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '17' THEN 1 ELSE 0 END) DAY_17
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '18' THEN 1 ELSE 0 END) DAY_18
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '19' THEN 1 ELSE 0 END) DAY_19
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '20' THEN 1 ELSE 0 END) DAY_20
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '21' THEN 1 ELSE 0 END) DAY_21
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '22' THEN 1 ELSE 0 END) DAY_22
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '23' THEN 1 ELSE 0 END) DAY_23
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '24' THEN 1 ELSE 0 END) DAY_24
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '25' THEN 1 ELSE 0 END) DAY_25
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '26' THEN 1 ELSE 0 END) DAY_26
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '27' THEN 1 ELSE 0 END) DAY_27
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '28' THEN 1 ELSE 0 END) DAY_28
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '29' THEN 1 ELSE 0 END) DAY_29
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '30' THEN 1 ELSE 0 END) DAY_30
							,SUM(CASE WHEN DATE_FORMAT(LOGIN_TIME,'%d') = '31' THEN 1 ELSE 0 END) DAY_31
					FROM 	USER_LOGIN
					WHERE 	LOGIN_TIME > STR_TO_DATE(CONCAT(#{YEAR_MONTH},'-01'),'%Y-%m-%d')
					GROUP	BY USER_ID 
				) A
                    LEFT OUTER JOIN USER U1 ON A.USER_ID = U1.USER_ID
	 	WHERE 	1 = 1		
		<if test="SEARCH_STR != null and SEARCH_STR != ''">
			<if test="CB_SEARCHKIND == 'USER_ID'">
			  AND UPPER(A.USER_ID) LIKE CONCAT('%',UPPER(#{SEARCH_STR}),'%') 
			</if>
			<if test="CB_SEARCHKIND == 'USER_NAME'">
			  AND UPPER(U1.USER_NAME) LIKE CONCAT('%',UPPER(#{SEARCH_STR}),'%') 
			</if>
		</if>			 
		ORDER BY U1.USER_NAME
	</select>    
</mapper>